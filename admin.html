<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Barbers — Admin</title>
    <style>
        :root {
            --bg: #050505;
            --panel: #0f1115;
            --panel-alt: #131720;
            --border: rgba(255, 255, 255, 0.08);
            --accent: #2979FF;
            --text: #f5f7fb;
            --muted: #9aa4b5;
            --danger: #ff5c5c;
            --success: #20c997;
            --font-display: 'Belgrad', serif;
            --font-body: 'Helvetica Neue', sans-serif;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 32px;
            background: radial-gradient(circle at 10% 20%, rgba(41,121,255,0.12), transparent 35%),
                        radial-gradient(circle at 90% 10%, rgba(32,201,151,0.1), transparent 30%),
                        radial-gradient(circle at 70% 80%, rgba(255,92,92,0.08), transparent 35%),
                        var(--bg);
            color: var(--text);
            font-family: var(--font-body);
            min-height: 100vh;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 24px;
        }

        h1 {
            margin: 0;
            font-family: var(--font-display);
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .pill {
            background: rgba(41, 121, 255, 0.14);
            color: var(--accent);
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 12px;
            border: 1px solid rgba(41,121,255,0.2);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .panel {
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)) no-repeat;
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 20px 80px rgba(0,0,0,0.45);
        }

        .panel h2 {
            margin: 0 0 6px;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .panel .sub {
            margin: 0 0 16px;
            color: var(--muted);
            font-size: 14px;
        }

        .actions {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }

        button, .button {
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 10px 14px;
            font-weight: 600;
            letter-spacing: 0.02em;
            cursor: pointer;
            transition: transform 0.1s ease, box-shadow 0.2s ease;
        }

        button:hover, .button:hover { transform: translateY(-1px); box-shadow: 0 10px 30px rgba(41,121,255,0.3); }
        button:active, .button:active { transform: translateY(0); }

        .table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.01);
            color: var(--text);
            font-size: 14px;
        }

        th, td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        th { text-transform: uppercase; letter-spacing: 0.08em; font-size: 12px; color: var(--muted); }

        tr:last-child td { border-bottom: none; }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            letter-spacing: 0.04em;
        }

        .badge.ok { background: rgba(32,201,151,0.12); color: var(--success); border: 1px solid rgba(32,201,151,0.2); }
        .badge.danger { background: rgba(255,92,92,0.12); color: var(--danger); border: 1px solid rgba(255,92,92,0.2); }
        .badge.dim { background: rgba(255,255,255,0.05); color: var(--muted); border: 1px solid var(--border); }

        .muted { color: var(--muted); }

        .pill-button {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 999px;
            cursor: pointer;
        }

        .pill-button:hover { border-color: rgba(41,121,255,0.4); }

        .status-line {
            min-height: 24px;
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        .status-line.ok { color: var(--success); }
        .status-line.error { color: var(--danger); }

        @media (min-width: 960px) {
            .grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <header>
        <div>
            <div class="pill">Internal</div>
            <h1>Admin Control</h1>
        </div>
        <button id="refreshAll">Refresh All</button>
    </header>

    <div class="grid">
        <section class="panel">
            <h2>Bookings</h2>
            <p class="sub">View latest reservations captured by the booking form.</p>
            <div class="actions">
                <button id="refreshBookings">Refresh</button>
                <span id="bookingStatus" class="status-line"></span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Barber</th>
                            <th>Service</th>
                            <th>Client</th>
                            <th>Contact</th>
                            <th>Created</th>
                        </tr>
                    </thead>
                    <tbody id="bookingsBody">
                        <tr><td colspan="8" class="muted">Loading bookings…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section class="panel">
            <h2>Reviews</h2>
            <p class="sub">Hide inappropriate comments; visible reviews stay live on the site.</p>
            <div class="actions">
                <button id="refreshReviews">Refresh</button>
                <span id="reviewStatus" class="status-line"></span>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>Rating</th>
                            <th>Comment</th>
                            <th>Created</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="reviewsBody">
                        <tr><td colspan="7" class="muted">Loading reviews…</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const bookingsBody = document.getElementById('bookingsBody');
        const reviewsBody = document.getElementById('reviewsBody');
        const bookingStatus = document.getElementById('bookingStatus');
        const reviewStatus = document.getElementById('reviewStatus');

        const setStatus = (el, message, type = '') => {
            if (!el) return;
            el.textContent = message;
            el.className = `status-line ${type}`.trim();
        };

        const formatDateTime = (dateStr, timeStr) => {
            const joined = timeStr ? `${dateStr}T${timeStr}` : dateStr;
            const date = new Date(joined);
            return isNaN(date.getTime()) ? `${dateStr} ${timeStr || ''}`.trim() : date.toLocaleString();
        };

        async function loadBookings() {
            setStatus(bookingStatus, 'Loading…');
            try {
                const res = await fetch('admin_bookings.php');
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load bookings');
                renderBookings(data.bookings || []);
                setStatus(bookingStatus, `Loaded ${data.bookings?.length || 0} bookings`, 'ok');
            } catch (error) {
                console.error(error);
                renderBookings([]);
                setStatus(bookingStatus, error.message || 'Error loading bookings', 'error');
            }
        }

        function renderBookings(bookings) {
            if (!bookingsBody) return;
            bookingsBody.innerHTML = '';
            if (!bookings.length) {
                bookingsBody.innerHTML = '<tr><td colspan="8" class="muted">No bookings found.</td></tr>';
                return;
            }

            bookings.forEach((b, idx) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.id ?? idx + 1}</td>
                    <td>${b.date || ''}</td>
                    <td>${b.time || ''}</td>
                    <td>${b.name || ''}</td>
                    <td>${b.specialty || ''}</td>
                    <td>${b.client_name || ''}</td>
                    <td>
                        <div>${b.client_email || ''}</div>
                        <div class="muted">${b.client_mobile || ''}</div>
                    </td>
                    <td>${formatDateTime(b.created_at || b.date, b.time)}</td>
                `;
                bookingsBody.appendChild(row);
            });
        }

        async function loadReviews() {
            setStatus(reviewStatus, 'Loading…');
            try {
                const res = await fetch('review.php?action=adminReviews');
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to load reviews');
                renderReviews(data.reviews || []);
                setStatus(reviewStatus, `Loaded ${data.reviews?.length || 0} reviews`, 'ok');
            } catch (error) {
                console.error(error);
                renderReviews([]);
                setStatus(reviewStatus, error.message || 'Error loading reviews', 'error');
            }
        }

        function renderReviews(reviews) {
            if (!reviewsBody) return;
            reviewsBody.innerHTML = '';
            if (!reviews.length) {
                reviewsBody.innerHTML = '<tr><td colspan="7" class="muted">No reviews yet.</td></tr>';
                return;
            }

            reviews.forEach((r, idx) => {
                const isHidden = Number(r.hidden) === 1;
                const row = document.createElement('tr');
                row.style.opacity = isHidden ? 0.55 : 1;
                row.innerHTML = `
                    <td>${r.id ?? idx + 1}</td>
                    <td>${r.name || ''}</td>
                    <td>${'★'.repeat(r.rating || 0)}${'☆'.repeat(5 - (r.rating || 0))}</td>
                    <td>${r.comment ? r.comment : '<span class="muted">No comment</span>'}</td>
                    <td>${formatDateTime(r.created_at || '')}</td>
                    <td>${isHidden ? '<span class="badge danger">Hidden</span>' : '<span class="badge ok">Visible</span>'}</td>
                    <td><button class="pill-button" data-id="${r.id}" data-hidden="${isHidden ? 0 : 1}">${isHidden ? 'Unhide' : 'Hide'}</button></td>
                `;
                reviewsBody.appendChild(row);
            });

            reviewsBody.querySelectorAll('button[data-id]').forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = Number(btn.dataset.id);
                    const hidden = Number(btn.dataset.hidden);
                    updateReviewVisibility(id, hidden);
                });
            });
        }

        async function updateReviewVisibility(id, hidden) {
            setStatus(reviewStatus, 'Updating visibility…');
            try {
                const res = await fetch('review.php?action=setVisibility', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id, hidden })
                });
                const data = await res.json();
                if (!res.ok || data.status !== 'success') throw new Error(data.message || 'Failed to update review');
                setStatus(reviewStatus, 'Updated review visibility', 'ok');
                await loadReviews();
            } catch (error) {
                console.error(error);
                setStatus(reviewStatus, error.message || 'Error updating review', 'error');
            }
        }

        document.getElementById('refreshBookings')?.addEventListener('click', loadBookings);
        document.getElementById('refreshReviews')?.addEventListener('click', loadReviews);
        document.getElementById('refreshAll')?.addEventListener('click', () => { loadBookings(); loadReviews(); });

        loadBookings();
        loadReviews();
    </script>
</body>
</html>
